<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Supabase Plot Demo</title>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

  <h1>Supabase Live Plot Demo</h1>
  <p id="status">Loading...</p>

  <input type="number" id="valueInput" placeholder="Enter a number">
  <button onclick="addData()">Add Data</button>

  <canvas id="myChart" width="400" height="200"></canvas>

  <!-- ‚úÖ USE MODULE MODE (THIS FIXES EVERYTHING) -->
  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

    const SUPABASE_URL = "https://sugekxazhhxmbzncqxyg.supabase.co";
    const SUPABASE_KEY = "sb_publishable_84h5tEu4ALMHkJWBxQeYdw_WqSSJiKd";

    const supabaseClient = createClient(SUPABASE_URL, SUPABASE_KEY);

    document.getElementById("status").textContent = "‚úÖ Supabase Connected";

    const ctx = document.getElementById("myChart").getContext("2d");

    const chart = new Chart(ctx, {
      type: "line",
      data: {
        labels: [],
        datasets: [{
          label: "Values",
          data: [],
          tension: 0.3
        }]
      }
    });

    async function loadData() {
      console.log("üîÅ Loading data...");

      const { data, error } = await supabaseClient
        .from("measurements")
        .select("*")
        .order("created_at", { ascending: true });

      if (error) {
        console.error("‚ùå LOAD ERROR:", error);
        document.getElementById("status").textContent = "‚ùå Load failed";
        return;
      }

      console.log("‚úÖ Data loaded:", data);

      chart.data.labels = data.map(d =>
        new Date(d.created_at).toLocaleTimeString()
      );

      chart.data.datasets[0].data = data.map(d => d.value);
      chart.update();
    }

    // ‚úÖ Must be attached to window for button onclick
    window.addData = async function () {
      const value = document.getElementById("valueInput").value;

      if (!value) {
        alert("Enter a value first");
        return;
      }

      console.log("‚¨ÜÔ∏è Inserting value:", value);

      const { data, error } = await supabaseClient
        .from("measurements")
        .insert([{ value: parseFloat(value) }]);

      if (error) {
        console.error("‚ùå INSERT ERROR:", error);
        document.getElementById("status").textContent = "‚ùå Insert failed";
        alert("Insert failed ‚Äî check console");
        return;
      }

      console.log("‚úÖ Insert successful:", data);
      document.getElementById("status").textContent = "‚úÖ Inserted!";

      document.getElementById("valueInput").value = "";
      loadData();
    };

    loadData();
  </script>

</body>
</html>
